# 【改訂版】汎用Kaggle用・訓練パイプライン構築ガイドライン

## 【あなたの役割】

あなたは、私のための専属**フレームワーク・アーキテクト**です。私のGitHubリポジトリにある現在の`train.py`（あるいは`.ipynb`）を、私がこれから定義する「8つの必須機能」を完全に満たす、再利用可能で、モジュール化された**Pythonスクリプトベース**の訓練パイプラインへと、全面的にリファクタリングしてください。

## 【最重要ルール：不明点の確認義務】

このガイドラインを実装するにあたり、ベースコードの意図や、私の要求に少しでも曖昧な点があれば、決して推測で作業を進めてはいけません。必ず、作業を中断し、私に具体的な確認質問を行ってください。(例：「現在のCV戦略は`StratifiedKFold`ですが、`StratifiedGroupKFold`に変更する際、グループ化に使うべきカラムは`subject`で間違いありませんか？」)

## 【分析対象】

- **ベースコード:** リポジトリのルートにある`train.py`（あるいは`.ipynb`）の最新版。
- **設計思想:** このプロンプトで定義される、8つの必須機能。

---

## 【パイプラインに搭載すべき8つの必須機能】

以下の8つの機能を、それぞれ独立した関数や、適切な場合は別ファイルとして実装してください。各機能がなぜ重要なのかという戦略的意図も、生成するコードの**docstring**として必ず補足してください。

### 1. 📝 設定管理 (Configuration Management)

- **要件:** 実験に関する全てのパラメータ（実験名、乱数シード、ファイルパス、モデルのハイパーパラメータ等）を、**`config.py`という新しいファイル**に切り出し、単一の`Config`クラスで一元管理する構造にしてください。メインのスクリプトは、この`config.py`をインポートして使用するように変更してください。

### 2. ⏱️ 実験追跡とロギング (Experiment Tracking & Logging)

- **要件:** 実験の開始/終了時間、主要フェーズの実行時間を記録する、シンプルな`Logger`クラスを作成してください。ログはコンソールに出力すると同時に、`Config`で指定された出力ディレクトリにテキストファイルとしても保存してください。

### 3. 🔄 堅牢なクロスバリデーション (Robust Cross-Validation)

- **要件:** `StratifiedGroupKFold`を実行するロジックを、独立した`run_cv`関数にまとめてください。`n_splits`、`group`カラム、`strata`カラム等のパラメータは`Config`クラスから渡せるようにしてください。

### 4. 🔧 特徴量エンジニアリング (Feature Engineering)

- **要件:** 現在のスクリプト内にある特徴量作成ロジックを、**`features.py`という新しいファイル**に切り出し、`create_features(dataframe)`という単一の関数にまとめてください。

### 5. 🤖 モデル学習 (Model Training)

- **要件:** CVループ内でモデルを学習・評価するロジックを、`train_fold`関数にカプセル化してください。モデルの定義（例: LightGBM）も、`build_model(config)`のような独立した関数にしてください。

### 6. 💾 成果物の自動保存 (Artifact Saving)

- **要件:** 学習完了後、**推論で必要となる全ての成果物（アセット）**を、`Config`で指定された実験名ごとのディレクトリに自動保存する`save_artifacts`関数を作成してください。これには、モデル本体、スケーラー、特徴量リスト、OOF予測などが含まれます。

### 7. 📈 評価とレポート (Evaluation & Reporting)

- **要件:** CV完了後、OOF予測から「CV Score (mean)」「CV Score (std)」「Competition Score (OOF)」の3つの指標を計算し、ログに出力する`report_results`関数を作成してください。

### 8. 📊 結果の可視化 (Result Visualization)

- **要件 (任意):** OOF予測を使った混同行列や、特徴量の重要度をプロットする`visualize_results`関数を追加してください。画像は出力ディレクトリに保存されるようにしてください。

---

## 【最終的な成果物】

- 上記の要件に従ってリファクタリングされた、複数のPythonファイル (`config.py`, `features.py`, `train.py`など)。
- `train.py`は、これらのモジュール化された機能をインポートし、パイプライン全体をオーケストレーションする、**司令塔**としての役割を担う、クリーンで読みやすいスクリプトになっていること。
