# 公開Notebook 逆解析プロンプト V2（作者の思考を深掘りする）

【あなたの役割】
- Kaggleコンペの「勝者」の思考パターンを解析し、再現可能な原理を抽出するエンジニア
- 目的: コードの背景にある**試行錯誤・失敗・トレードオフの記録**を読み取り、スコア上昇の本質的な要因を特定する

【一次入力（必須）】
- 対象Notebookの完全コード + コメント・ドキュメンテーション
- 可能であれば、Kaggle Discussion / Notebook Comments（試行錯誤の痕跡）

【二次入力（参考）】
- 当リポジトリ内の高スコアNotebookコード + コメント
- 当リポジトリ内の`docs/04_knowledge.md`（共通原理・採用方針）

【出力要件（構造化）】

## 1) 概要と前提（What/Why/Constraints）
- **目的**: コードから推定される目標スコア、評価指標の定義
- **制約**: メモリ、計算時間、提出形式、CV-LBギャップへの対応姿勢
- **成功の定義**: LBスコアだけでなく、「再現性」「安定性」を重視しているか？

---

## 2) 作者の思考フロー（Thinking Process - 最重要）

### 2.1 問題認識（What problem are they solving?）
- コード・コメント・Discussionから、「このNotebook作者が解決しようとした課題」を推定
  - 例：「CV-LBギャップが大きいから、ラボ間ドメインシフト対策を優先」
  - 例：「rare行動の検出精度が低いから、クラス別閾値調整に注力」
  - **選択肢の比較検証や、捨てた案・失敗例・コメントアウト部分も必ず抽出**

### 2.2 アプローチの選択根拠（Why this approach?）
- 「なぜLGBMではなくkNNなのか」「なぜこの特徴量セットなのか」
- **パラメータ履歴・コメント・Discussionから、選択理由や他案との比較を明示**
- 外部要因（計算リソース、提出回数、Kaggle仕様）も考慮

### 2.3 失敗・制約からの学習（Failures and Tradeoffs）
- コードに「if文で条件分岐」「警告処理」「フォールバック」がある場所を抽出
  - これは「過去に失敗したパターン」を示唆
  - 例：`if X_tr.shape[0] > threshold: model.fit() else: return dummy_pred`
    → 「バッチサイズが小さすぎると過学習する」という学習の痕跡
- 「捨てられた特徴量」の手がかり（コメントアウト部分、TODO）

---

## 3) 設計意図の深掘り（Design Intent Analysis）

### 3.1 特徴量設計
| 特徴量 | 実装コード行 | 推定意図 | 期待効果 | リスク | 失敗例・ボツ案 |
|:------|:--------:|:------:|:------:|:----:|:----:|
| rolling平均 | line XX | NaNノイズ低減 | 安定性向上 | 情報損失 | コメントアウト: rolling=3は効果なし |

### 3.2 後処理の優先度
- 「robustify」「event結合」「fps補正」の実装順序を観察
- 実装順序は、作者が重視する課題の優先順を反映

### 3.3 CV設計の思想
- GroupKFold vs StratifiedKFold の選択理由を推定
- ラボ別CV、アクション別CV、時間別CVの試行痕跡を探索

---

## 4) 比較・差分分析（Comparative Analysis）

### 4.1 当リポとの相違点
- このNotebookで採用されて、当リポで未採用の工夫は？
- 逆に、当リポで採用済みで、このNotebookで採用されていない工夫は？
- **理由の仮説**を記述（計算コスト、安定性、検証困難性など）

### 4.2 他の高スコアNotebookとの共通点・相違点
- mabe-v1(0.41)との差分：
  - 共通している要素 → これが「本質的」な可能性
  - 相違している要素 → 「作者固有のアイデア」か「同等の代替案」か？

---

## 5) スコア上昇の「真の要因」の推定（Root Cause Analysis）

### 5.1 スコア向上への寄与度の仮説
| 要素 | 寄与度推定 | 根拠 | 確実性 | 定量的検証 |
|:---:|:--------:|:---:|:----:|:----:|
| 特徴量 | 30% | 情報量の増加 | 中 | アブレーション: +0.02 |
| 後処理 | 40% | コード行数と複雑度 | 中 | A/Bテスト: +0.01 |
| CV分割 | 20% | ラボ分布対応 | 中 | ラボ別CV: +0.01 |
| 提出形式 | 10% | robustify実装 | 高 | メモリ・計算時間の制約を超えないか |

### 5.2 「本質的な差」と「微調整」の切り分け
- **本質的な差**：複数の高スコアNotebookが共通して採用している工夫
- **微調整**：このNotebook固有の工夫（スコア向上に寄与する可能性は低い）

---

## 6) 移植時のリスク評価（Migration Risks）

### 6.1 「このアプローチは当リポで動作するか」の検証計画
- 提出形式は公式評価関数と整合するか
- メモリ・計算時間の制約を超えないか

### 6.2 「実装複雑度 vs スコア向上」のトレードオフ
- 実装難度が高いわりに、スコア向上が小さい工夫は「P2」に格下げ
- 例：複雑な状態管理ループ（実装難）vs rolling平滑化（実装簡単）

---

## 7) 批判的観点（Devil's Advocate Check）

### 7.1 「このNotebookは本当に0.41を達成したか」の確認
- Leaderboard Score、Submission Date、Version historyを確認
- 公開ブックのスコアは信頼できるか（再現性、過学習の可能性）

### 7.2 「このアプローチは一般的か、それともこのコンペ限定か」
- 同じ手法が他のKaggleコンペや時系列/行動認識タスクで通用するか
- Kaggle特有の事情（提出回数制限、評価指標バグ等）も考慮

---

## 8) 最終的な優先実装リスト（Priority Action Plan）

### P0（即座に移植、高リターン・低リスク）
- [ ] 実装内容
- [ ] 理由：作者の思考から推定される必須要素
- [ ] 検証計画：validate modeで0.01以上のスコア向上を確認

### P1（中期、要検証）
- [ ] 実装内容
- [ ] 理由：複数の高スコアNotebookで共通
- [ ] 検証計画：アブレーション実験で効果を定量化

### P2（研究枠、低優先度）
- [ ] 実装内容
- [ ] 理由：この作者固有、または実装難度が高い
- [ ] 検証計画：パラメータ最適化の余地あり

---

## 9) 納品物（Deliverables）

- `research/<notebook_name>/author_intent_v2.md` （本解析レポート）
- `research/<notebook_name>/risk_assessment.md` （リスク評価）
- `docs/04_knowledge.md` への追記案 （共通原理・採用方針）
- `experiments/EXP009T/move_plan.md` （移植計画書）

---

## 【スタイル/制約】
- **断定を避ける**：「〜と推定される」「〜の可能性がある」を明示
- **根拠コードを引用**：推定は必ずコード行を参照
- **試行錯誤の痕跡を探す**：コメント、警告、条件分岐に注目
- **当リポの運用ルール**を常に念頭に：提出形式・self行動・CV検証の必須性