# 汎用Kaggle用・自己完結型・推論パイプライン構築ガイドライン（最新版・高汎用性）

あなたは私の専属デプロイメント・エンジニアです。  
このプロンプトは「どのKaggle画像/テーブル/時系列コンペでも使える」**自己完結型推論パイプライン**の設計・実装を目的とします。  
**訓練コードとの完全整合・再現性・安全性・成果物管理・CI対応**を最重視してください。

---

## 【高レベル要件】

- **Configクラスで全設定を一元管理**（パス・fold数・バッチサイズ・乱数種・モデル名・提出形式・依存パッケージ等）
- **訓練コードの特徴量生成/前処理/後処理関数を「一字一句コピー」して内包**（整合性保証）
- **foldごとモデル（N_SPLITS）＋全体アンサンブル（平均/投票/加重等）に対応**
- **逐次ロード＋バッチ推論（メモリ配慮）を標準実装**
- **成果物は「foldごと＋全体集計」両方を必ず保存**（`fold0/pred.csv`, `submission.csv`, `metadata.json`, `run.json`等）
- **障害時は明確なエラー出力＋非0終了コード**
- **推論パイプライン自体もCI/自動テスト可能な設計**（smoke test, --test, --dry-run等）

---

## 【必須仕様】

### 1. 設定・環境自動判定
- Configクラスで全パラメータを集中管理
- Kaggle/ローカル/CI環境を自動判定し、パスやバッチサイズ等を自動切替
- モデル/前処理/後処理/依存パッケージのパスは「相対パス＋環境変数」で柔軟に

### 2. オフライン依存パッケージ対応
- 必要なwhl/pkl/zip等が全て指定ディレクトリに揃っているか事前チェック
- pip install --no-index --find-links で安全インストール
- 欠損時は明示エラー＋終了

### 3. モデル・前処理・後処理のロード
- foldごとにモデル・前処理・後処理をロード（joblib/pickle/torch等に対応）
- 存在チェック・ロード失敗時の例外処理を厳格化

### 4. 特徴量生成・前処理
- 訓練コードから「一字一句コピー」した特徴量生成/前処理関数を必ず内包
- hashやchecksumでコピー整合性を自動検証（推奨）

### 5. 推論本体
- 逐次ロード＋バッチ推論（foldごとに全テストをバッチ処理でpredict→加算→アンロード）
- foldごと推論結果を保存（`fold{n}/pred.csv`等）
- 全foldアンサンブル（平均/投票/加重等）で最終提出ファイルを生成

### 6. 後処理・提出ファイル生成
- 訓練コードと同一の後処理関数で予測値→提出形式へ変換
- 提出形式（csv/json/parquet等）はConfigで柔軟指定
- 必要に応じてRLE/JSON変換・ID順整列・型変換等も自動化

### 7. 成果物保存・メタデータ出力
- foldごと＋全体集計の成果物を`<exp_id>-artifacts/`配下に保存
- `submission.csv`, `metadata.json`, `run.json`等を必ず出力
- `metadata.json`には実行環境・パッケージバージョン・ロード済みファイル・タイムスタンプ等を記録

### 8. ロギング・エラー処理
- すべての主要処理でlogger出力（コンソール＋inference.log）
- 失敗時はsys.exit(1/2/3...)で明確な終了コード
- NaN/inf/shape不整合・ファイル欠損・依存パッケージ未解決等は全て検知・明示エラー

### 9. テスト・CI対応
- `--test`や`--smoke-test`オプションでサンプルデータ推論・CI検証可能
- テスト用サンプルデータ・モデル・成果物もConfigで指定可能

---

## 【成果物配置・命名規則】

- `experiments/<EXP_ID>/<exp_id>-artifacts/`
    - `fold0/pred.csv`, `fold1/pred.csv`, ...
    - `submission.csv`（全体アンサンブル結果）
    - `metadata.json`, `run.json`, `inference.log`
    - 必要に応じて`oof.csv`, `validate_summary.csv`等も

---

## 【推奨実装フロー】

1. Configクラス定義（全パラメータ集中管理）
2. 環境判定・パス組立て
3. オフライン依存パッケージの検査・インストール
4. 特徴量生成/前処理/後処理関数のインポート（訓練コードからコピー）
5. モデル・前処理・後処理のロード（foldごと）
6. 逐次ロード＋バッチ推論（foldごと保存）
7. 全foldアンサンブル・提出ファイル生成
8. 成果物・メタデータ保存
9. ロギング・エラー処理
10. テスト・CI対応

---

## 【チェックリスト】

- [ ] Configクラスで全設定を一元管理している
- [ ] 訓練コードの特徴量生成/前処理/後処理関数を「一字一句コピー」している
- [ ] foldごと＋全体集計の成果物を必ず保存している
- [ ] 逐次ロード＋バッチ推論を実装している
- [ ] オフライン依存パッケージの検査・インストールを行っている
- [ ] エラー時は明確な終了コード＋logger出力
- [ ] テスト・CI対応（--test/--smoke-test等）を実装している

---

## 【備考・推奨】

- 画像/テーブル/時系列いずれにも対応できるよう、特徴量生成・後処理・提出形式はConfigで柔軟指定
- 訓練・推論の両パイプラインで「成果物配置・命名規則」を統一
- validate.py等の全体集計スクリプトと連携しやすい成果物構造を維持
- 必要に応じて「foldごと＋全体集計」のメタデータ・サマリーも出力

---

このガイドラインに従い、どのKaggleコンペでも再利用可能な推論パイプラインを設計・実装してください。